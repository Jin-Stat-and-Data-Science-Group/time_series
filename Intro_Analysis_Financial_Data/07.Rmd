---
title: "第七章"
author: "Zeng"
date: '2019-12-10'
output: pdf_document
css: ./style/markdown.css
bibliography: Bibfile.bib
eqnPrefixTemplate: ($$i$$)
link-citations: true
linkReferences: true
notice: '@*'
csl: ./style/chinese-gb7714-2005-numeric.csl
autoEqnLabels: true
---


```{r setup, echo=F}

################# 第 1 章 R 程序代码  ####################


knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

```{r prepare}
rm(list=ls())
options(digits=4)
options(scipen=100)
graphics.off()
Sys.setlocale("LC_ALL", "Chinese")
```


# VaR
根据巴塞尔协议，金融风险被分为3类，即市场风险、信用风险和操作风险，如果需要，也可以把流动性风险作为一类额外的金融风险。市场风险是指和股票价格变动、利率变动、汇率变动、商品价格变化等所导致的损失有关的风险。它包括股权风险、利率风险、汇率风险、商品风险和波动率风险。因为股票价格和利率数据容易获得并且数据质量较高，所以市场风险是一种被广泛研究和理解的金融风险。本章将重点介绍这类风险。

信用风险也称为违约风险或者交易对手风险。当借贷者不能如约还贷时就发生了信用风险。这种风险包括消费信贷风险、集中风险、证券化风险和信用衍生品风险。

操作风险是由于内部程序、人员和系统的不完备或失效，或由于外部事件造成的风险。法律或者政治风险是操作风险的两个例子。

## 风险测度和一致性
由于损失的分布是未知的，很难根据已有的数据对它们进行充分的估计，所以在实际应用中，我们经常应用一些概要统计量来量化这些损失的分布。风险测度就是概要统计量的一种。简单说，风险测度就是从损失随机变量到实际损失的映射。它给出了潜在风险的一个估计值。

首先，一个有意义的金融风险测度必须和基本的金融理论一致。设
$\eta$为一个风险测度。对于任意两个随机变量X和Y，如果它们满足下面四个条件，则称$\eta$为一致的风险测度：

- 1) 次可加性：$\eta (X + Y) \le \eta (X) + \eta (Y)$

- 2) 单调性：如果对所有的结果，有$X \leqslant Y$,则有$\eta (X) \le \eta (Y)$。

- 3) 正齐性：对任意正常数c，有$\eta (cX) = c\eta (X)$

- 4) 变换不变性：对任意正常数c，有$\eta (X + c) = \eta (X) + c$

### 风险值
风险值(VaR)也许是最有名的风险度量了。它是一个处于某类风险的机构头寸由于市场变化而在某个给定持有期头寸减少的估计值。

下面我们应用一个金融头寸在某个给定时期的损失这一随机变量来定义VaR。假设在时刻t，我们需要了解一个金融头寸在接下来的l期的风险。用${L_t}(l)$表示该头寸的损失随机变量。设$V_t$为该头寸在时刻t的价值，那么根据该金融头寸是多头或者空头，${L_t}(l)$或者为$V_{t+l}-V_t$的正函数或者负函数。设${F_t}(l)$为变量${L_t}(l)$的累积分布函数(CDF)。
由于大的损失发生的频率较小，所以我们用较小的概率来估计损失。例如5%，或者1%，或者0.1%。用p表示概率，则在持有期l中一个金融头寸概率为p的VaR的定义为：\[Va{R_{1 - p}} = \inf \{ x|{F_t}(x) \ge 1 - p\} \]这里inf表示满足条件的实数x的最小值。从定义中可知，$F(Va{R_{1 - p}}) \ge 1 - p$，即$$\Pr [{L_t}(l) \le Va{R_{1 - p}}] \ge 1 - p$$因此，从时刻$t$到时刻$t+l$，该金融寸头持有者的潜在损失小于或等于$Va{R_{1 - p}}$的概率为1-p。
应用性质$\Pr [{L_t}(l) \le x] = 1 - \Pr [{L_t}(l) > x]$，我们有\[\Pr [{L_t}(l) > Va{R_{1 - p}}] \le p\]所以，在从时刻$t$到时刻$t+l$期间内，该头寸持有者的损失大于$Va{R_{1 - p}}$的概率至多为p。
上面的定义表明，VaR和损失变量分布函数(CDF)${F_t}(x)$的右尾概率有关。对于一元分布函数${F_t}(x)$和给定的函数q，且0<q<1，称\[{x_q} = \inf \{ x|{F_t}(x) \ge q\} \]为${F_t}(x)$的**q分位数**。如果相应于与${F_t}(x)$的随机变量${L_t}(l)$是连续的，那么$q = \Pr [{L_t}(l) \le {x_q}]$。设q=1-p，可以看出VaR就是损失函数的(1-p)分位数，这里的p是一个取值较小的尾部概率。

**讨论**

第一，对于一些常见的分布，VaR简单并容易计算。

**情形1**：正态分布

如果损失随机变量X为正态分布，记为$X \sim N({\mu _t},\sigma _t^2)$，那么我们有$$Va{R_{1 - p}} = {\mu _t} + {z_{1 - p}}\sigma _t$$这里$z_{1 - p}$表示标准正态分布的(1-p)分位数，下标t用于表示VaR是随着时间变化的。在R中可以用命令qnorm(q)得到标准正态分布的q分位数。

**情形2**：t分布

如果损失随机变量X满足：变量$Y = (X - {\mu _t})/{\sigma _t}$为自由度为v的t分布，那么$$Va{R_{1 - p}} = {\mu _t} + {t_{1 - p,v}}{\sigma _t}$$这里${t_{1 - p,v}}$是自由度为v的t分布的1-p分位数。在R中可以用命令qt(q,v)得到自由度为v的t分布的q分位数。

**情形3**：标准t分布

如果v>2,则在情形2中的t分布的随机变量Y的方差为v/v-2.在波动率建模中，可以应用Y的标准化版本作为新息。可以通过下列变换实现：$${Y^*} = {Y \over {\sqrt {v/(v - 2)} }} = {{X - {\mu _t}} \over {{\sigma _t}\sqrt {v/(v - 2)} }}$$因此，我们有$$Va{R_{1 - p}} = {\mu _t} + t_{1 - p,v}^*{\sigma _t}\sqrt {v/(v - 2)} $$这里，$t_{1 - p,v}^*$是自由度为v的标准t分布的1-p分位数。在R的fGarch包中，可以使用命令qstd(q,nu=v)得到自由度为v的标准t分布的q分位数.

第二，如果损失随机变量服从正态分布，则VaR是一个一致性的风险度量。而在一般情况下VaR不是一个一致性的风险度量。

第三，VaR是一个右尾概率为p的分位数。它并没有描述损失随机变量的实际尾部行为。可以容易地构造出两个损失随机变量，它们具有相同的给定概率为p的VaR，打算二者的尾部行为却大不相同。这种情况下，尽管这两个损失变量的VaR相同，但它们的真实风险是不同的。

### 期望损失
为了克服VaR的不足之处，在金融计量学中引入了一个新的风险度量，即期望损失(ES)。在精算学中又被称为尾部风险值(TVaR)。简单地说，ES就是在一个灾难事件后某个金融头寸的期望损失。考虑持有期为l的某个金融头寸的损失随机变量X。设X的累积分布函数和概率密度函数分别为F(x)和f(x)。对于给定的尾部概率p，令VaR是X的风险估计值。这里，为了简单，省略了VaR的下标1-p。那么，X的期望损失(ES)的定义为：$$E{S_{1 - p}} = E(X|X > VaR) = {{\int_{{\rm{VaR}}}^\infty  {xf(x)dx} } \over {\Pr (X > VaR)}}$$从上述定义可知，ES是在X超出VaR是X的期望损失。所以ES也被称为条件风险值(CVaR)。因为ES着重与损失分布右尾部的行为，所以又称为TVaR。
为了简单，假设X为连续变量。设u=F(x)，其中$VaR <x< \infty$ 。那么，我们有du=f(x)dx，F(VaR)=1-p,$F(\infty)=1$，且$x=F^{-1}(u)=VaR_u$，从而ES定义可写为：$$E{S_{1 - p}} = {{\int_{1 - p}^1 {Va{R_u}du} } \over p}$$因此，对于$1 - p \le u \le 1$，ES就是所有$VaR_u$的均值。ES的平均值特性使得它比VaR能更好地反映损失随机变量X的尾部行为。事实上，可以证明ES是一个具有一致性的风险度量。
对于某些损失分布，可以写成它们的ES的解析表达式

**情形1**(正态分布)：设损失随机变量X为正态分布，记为$X \sim N({\mu _t},\sigma _t^2)$。那么ES就是左端截断的正态随机变量的期望值。ES的解析表达式如下：$$E{S_{1 - p}} = {\mu _t} + {{f({z_{1 - p}})} \over p}{\sigma _t}$$其中，f(z)是标准正态分布随机变量的密度函数，$z_{1-p}$是f(z)的(1-p)分位数，而p是一个较小的尾部概率。在R中可用命令dnorm(qnorm(q))得到q分位数对应的密度函数取值。

**情形2**(自由度为v的t分布)：如果损失随机变量X满足：变量$Y = (X - {\mu _t})/{\sigma _t}$为自由度为v的t分布，那么有$$E{S_{1 - p}} = {\mu _t} + {\sigma _t}{{f({x_{1 - p}})} \over p}({{v + x_{1 - p}^2} \over {v - 1}})$$这里$f_v(x)$是自由度为v的t分布的概率密度函数，$x_{1-p}$是$f_v(x)$的1-p分位数。在R中使用dt(qt(q,v), v)得到对应的概率密度取值。

**情形3**(自由度为v的标准t分布)：假设损失随机变量X满足$${Y^*} = {Y \over {\sqrt {v/(v - 2)} }} = {{X - {\mu _t}} \over {{\sigma _t}\sqrt {v/(v - 2)} }}$$服从自由度为v的标准t分布，其中v>2，这时，我们有$$E{S_{1 - p}} = {\mu _t} + {\sigma _t}\sqrt {v/(v - 2)} {{f_v^*(x_{_{1 - p}}^*)} \over p}({{(v - 2) + {{[x_{1 - p}^*]}^2}} \over {v - 1}})$$这里$f_{1-p}^*(x)$是自由度为v的标准t分布的概率密度函数，$x_{1-p}^*$是$f_{1-p}^*(x)$的1-p分位数。在R中使用dstd(qstd(q, nu=v), nu=v)得到对应的概率密度取值。

## 计算风险度量的注记
计算VaR涉及多个因素：

- 1)感兴趣的概率p的取值。例如，在风险管理中，取p=0.01，在压力测试中，取p=0.001。在某种意义上，p的选择是随意的。

- 2)时间跨度l。它可以由监管委员会给出，例如市场风险要求1天或者10天，信用风险要求1年或者5年。

- 3)数据的频率。它可能和时间跨度l不同。在市场风险分析中，经常取日观测值。而在信用风险建模中，经常取月或者季度数据。

- 4)损失随机变量的累积分布函数$F_t(x)$或者它的分位数。

- 5)金融头寸的数量或者组合的盯市价值。
在上述因素中，累计分布函数$F_t(x)$是计量经济建模的焦点。累积分布函数的不同估计方法将给出计算VaR和ES的不同方法。
由于金融资产的对数收益率近似相当于该资产价值的百分比变化，所以在数据分析中我们应用对数收益率$r_t$，对于多头，当$r_t$为负值时就发生了损失。另一方面，对于空头，当$r_t$为正值时就发生损失。因此，在本章中，损失随机变量的定义如下：$${x_t} = \left\{ {\matrix{{{r_t} \qquad \text{如果是空头}}  \cr { - {r_t} \qquad\text{如果是多头}}\cr}}\right.$$在给定到时刻t为止的所有可知信息的条件下，从损失分布的右侧分位数计算的VaR是以百分比来计算的。因此，以美元记得VaR是金融头寸的现金价值乘以损失变量的VaR。即VaR=现金价值c×$x_t$的VaR。也可以用近似公式VaR=现金价值×[exp($x_t$的VaR)-1]。

## 风险度量制
风险度量制的简单形式假定组合的连续复合日收益率$r_t$服从一个条件正态分布。用$x_t$表示日损失随机变量，$F_{t-1}$表示t-1时刻可以得到的信息集合。风险度量制假定${x_t}|{F_{t - 1}} \sim N(0,\sigma _t^2)$，其中$\sigma _t^2$是$x_t$的条件方差，并假定它安装下面的简单模型随时间变化：$$\sigma _t^2 = \alpha \sigma _{t - 1}^2 + (1 - \alpha )x_{t - 1}^2,0 < \alpha  < 1$$因此，此方法假定组合的日价格的对数$p_t=ln(P_t)$满足差分方程$p_t-p_{t-1}=a_t$，其中${a_t} = {\sigma_t}{\varepsilon _t}$是一个无漂移的IGARCH(1, 1)过程，α通常在区间(0.9, 1)取值，其中常用的值为0.94.
这样一个特殊的随机游走IGARCH模型的良好性质是，利用它很容易得到一个多期损失的条件分布。具体来讲，对k个周期的持有期，从时刻t+1到时刻t+k的损失变量为${x_t}[k] = {x_{t + 1}} +  \cdot  \cdot  \cdot  + {x_{t + k - 1}} + {x_{t + k}}$。方括号[k]表示持有期为k。在上面特定的IGARCH(1,1)模型下，条件分布${x_t}[k]|{F_t}$是均值为0，方差为$\sigma _t^2 [k]$的正态分布。由${\varepsilon _t}$的独立性假定和上述模型式，我们有$$\sigma _t^2[k] = Var({x_t}[k]|{F_t}) = \sum\limits_{i = 1}^k {Var({a_{t + i}}|} {F_t})$$其中${Var({a_{t + i}}|} {F_t})=E(\sigma _{t+i}^2|{F_t})$可以递归地得到。利用${x_{t - 1}} = {a_{t - 1}} = {\sigma _{t - 1}}{\varepsilon _{t - 1}}$，我们可以把IGARCH(1,1)模型的波动率方程改写为$$\sigma _t^2 = \sigma _{t - 1}^2 + (1 - \alpha )\sigma _{t - 1}^2(\varepsilon _{t - 1}^2 - 1), \qquad \text{对所有t} $$特别地，我们有$$\sigma _{t + i}^2 = \sigma _{t + i - 1}^2 + (1 - \alpha )\sigma _{t + i - 1}^2(\varepsilon _{t + i - 1}^2 - 1), \qquad i=2,...,k$$因为对于$i \ge 2$，$E(\sigma _{t+i-1}^2-1|{F_t})=0$,所以上面的方程表明$$E(\sigma _{t + i}^2{\rm{|}}{F_t}) = E(\sigma _{t + i - 1}^2{\rm{|}}{F_t}),i = 2,...,k$$该式证明了对于$i \ge 1$，$Var({x_{t + i}}|{F_t}) = \sigma _{t + 1}^2$，从而$\sigma _t^2[k] = k\sigma _{t + 1}^2$。上述结果说明$_t[k]|{F_t} \sim N(0,k\sigma _{t + 1}^2)$.因此，在上述特殊的IGARCH(1,1)模型下，$x_t[k]$的条件方差与时间段k成比例。一个持有期为k的损失变量的条件标准差为
$\sqrt k {\sigma _{t + 1}}$，即$\sqrt k$倍$\sigma _{t + 1}$。
给定尾部概率，风险度量制应用结果$x_t[k]|{F_t} \sim N(0,k\sigma _{t + 1}^2)$来计算随机损失变量的VaR。如果尾部概率p=5%，则下一个交易日的$VaR=1.65\sigma _{t + 1}^2$.对于接下来的k个交易日，我们有$VaR[k]=1.65\sqrt k\sigma_{t+1}$，它是$N(0,k\sigma _{t + 1}^2)$的第95百分位数。
考虑p=0.01的情况。在风险度量制下，资产组合的下一个交易日的VaR为：$$VaR=\text{头寸数量}\times 2.326\sigma _{t + 1}$$持有期为k天的VaR为$$VaR[k]=\text{头寸数量}\times 2.326\sqrt k\sigma _{t + 1}$$其中，VaR的参数(k)用来表示持有的时间段，并且证券组合的价值是用美元来衡量的。因此，在风险度量制下，我们有$$VaR(k)=\sqrt k \times VaR$$这称为风险度量制下VaR计算中的时间平方根准则。
注意，因为风险度量制假定对数收益率服从均值为0的正态分布，所以损失函数是对称的，对于多头金融寸头和空头金融寸头而言，VaR是相同的。

### 讨论
风险度量制的一个优点就是简单，并易于理解和运用；另外一个优点是它使得金融市场中的风险更加透明。然而，因为证券收益率常常有厚尾，所以正态性假定通常导致VaR的低估。其他计算VaR的方法避免做这样的假定。
时间平方根准则是风险度量制中运用特殊模型的一个结果。如果对数收益率的零均值假定或者特殊IGARCH(1,1)模型假设不满足，则此准则就失效了。考虑下面这个简单的模型：$$\eqalign{
  & {r_t} = \mu  + {a_t},{a_t} = {\sigma _t}{\varepsilon _t},\mu  \ne 0  \cr 
  & \sigma _t^2 = \alpha \sigma _{t - 1}^2 + (1 - \alpha )a_{t - 1}^2 \cr} $$其中$\varepsilon _t$是标准高斯白噪声序列，$\mu  \ne 0$的假定对许多在NYSE中大量交易的股票收益率都是成立的。对于上面这一简单模型，给定$F_t$下$r_{t+1}$的分布是$N(\mu ,\sigma _{t + 1}^2)$。用来计算持有1期VaR的95%分位数变为$\mu  + 1.65{\sigma _{t + 1}}$，持有期为k时，给定$F_t$下$r_t[k]$的分布为$N(k\mu ,k\sigma _{t + 1}^2)$，与前面一样，${r_t}[k] = {r_{t + 1}} +  \cdot  \cdot  \cdot  + {r_{t + k}}$。持有期为k的VaR计算中所应用的95%分位数是$k\mu  + \sqrt k 1.65{\sigma _{t + 1}} = \sqrt k (\sqrt k \mu  + 1.65{\sigma _{t + 1}})$。因此，当平均收益率不为0时，$VaR(k) \ne \sqrt k  \times VaR$。也很容易证明当收益率的波动率模型不是无漂移的IGARCH(1,1)模型时，这个准则也是失效的。

### 多个头寸
在一些应用中，投资者可能持有多个头寸，并且需要计算头寸的全部VaR。做这样的计算时，在假定每个头寸的日对数收益率服从一个随机游走IGARCH(1,1)模型下，风险度量制采取了一个简单方法。需要的额外量是收益率间的交叉相关系数。考虑两个头寸的情况下，令$VaR_1$和$VaR_2$表示两个头寸，$\rho_{12}$表示两个收益率间的交叉相关系数，即${\rho _{12}} = Cov({r_{1t}},{r_{2t}})/{[Var({r_{1t}})Var({r_{2t}})]^{0.5}}$。则投资者的全部VaR为$$VaR = \sqrt {VaR_1^2 + VaR_2^2 + 2{\rho _{12}}Va{R_1}Va{R_2}}$$一个包含m个工具的头寸的VaR可以直接得到，即$$VaR = \sqrt {\sum\limits_{i = 1}^m {VaR_i^2 + 2\sum\limits_{i < j}^m {{\rho _{ij}}Va{R_i}Va{R_j}} } } $$其中$\rho_{ij}$是第i个与第j个工具的收益率间的交叉相关系数，$VaR_i$表示第i个工具的VaR。

## VaR计算的计量经济学方法
VaR和ES计算的一个一般方法就是利用第2~4章的时间序列计量经济模型。对于一个对数收益率序列，可以利用第2章中的时间序列模型来对均值方程建模，并且可以利用第4章的条件异方差模型来处理波动率。为了简单，我们在讨论中利用了GARCH模型，并将此方法称为VaR和ES计算的计量经济学方法。也可以利用其它的波动率模型。
考虑一个金融头寸的损失变量$x_t$，它的通用时间序列模型可以写为：$$\eqalign{
  & {x_t} = {\phi _0} + \sum\limits_{i = 1}^p {{\phi _i}} {x_{t - i}} + {a_t} - \sum\limits_{j = 1}^q {{\theta _j}{a_{t - j}}}   \cr 
  & {a_t} = {\sigma _t}{\varepsilon _t}  \cr 
  & \sigma _t^2 = {\alpha _0} + \sum\limits_{i = 1}^u {{\alpha _i}a_{t - i}^2}  + \sum\limits_{j = 1}^v {{\beta _j}} \sigma _{t - j}^2 \cr} $$

### 多个周期VaR
假设在时刻h，我们希望计算损失变量为$x_t$的一个金融头寸的k期风险度量。这样，感兴趣的变量是在预测原点h处的k期累积损失(即${x_h}[k] = {x_{h + 1}} +  \cdot  \cdot  \cdot  + {x_{h + k}}$)。如果损失变量$x_t$服从上面的时间序列模型，则可以应用第2章和第4章中讨论的预测方法来获得${x_h}[k]$在给定信息集$F_h$下的条件均值和条件方差。

#### 期望损失和预测误差
可以利用第2章中的ARMA模型的预测方法来得到条件均值$E({x_h}[k]|{F_h})$。具体来讲，我们有$${{\hat x}_h}[k] = {x_h}(1) +  \cdot  \cdot  \cdot  + {x_h}(k)$$其中${x_h}(l)$是在预测原点h时收益率的超前l步预测。这些预测可以应用第2章讨论的递归方法来计算。利用ARMA模型的MA表示$${x_t} = \mu  + {a_t} + {\psi _1}{a_{t - 1}} + {\psi _2}{a_{t - 2}} +  \cdot  \cdot  \cdot $$我们可以将预测原点h处的超前l步预测误差记为$${e_h}(l) = {x_{h + l}} - {x_h}(l) = {a_{h + l}} + {\psi _1}{a_{h + l - 1}} + {\psi _2}{a_{h + l - 2}} +  \cdot  \cdot  \cdot  + {\psi _{l - 1}}{a_{h + 1}}$$从而k期期望收益率的预测误差${{\hat x}_h}[k]$是$x_t$在预测原点h处的超前1步预测误差的和，可以写为$$\eqalign{
  & {e_h}(k) = {e_h}(1) + {e_h}(2) +  \cdot  \cdot  \cdot  + {e_h}(k)  \cr 
  &  = {a_{h + 1}} + ({a_{h + 2}} + {\psi _1}{a_{h + 1}}) +  \cdot  \cdot  \cdot  + \sum\limits_{i = 0}^{k - 1} {{\psi _i}{a_{h + k - i}}}   \cr 
  &  = {a_{h + k}} + (1 + {\psi _1}){a_{h + k - 1}} +  \cdot  \cdot  \cdot  + (\sum\limits_{i = 0}^{k - 1} {{\psi _i})} {a_{h + 1}} \cr} $$其中$\psi_0=1$

#### 期望波动率
k期损失变量在预测原点h处的波动率预测是在给定$F_h$下的条件方差${e_h}[k]$。利用${\varepsilon _{t + i}}（i=1,..,k)$的独立性假定，且${a_{t + i}} = {\sigma _{t + i}}{\varepsilon _{t + i}}$，我们有$$\eqalign{
  & {V_h}({e_h}[k]) = {V_h}({a_{h + k}}) + {(1 + {\psi _1})^2}{V_h}({a_{h + k - 1}}) +  \cdot  \cdot  \cdot  + (\sum\limits_{i = 0}^{k - 1} {{\psi _i}{)^2}} {V_h}({a_{h + 1}})  \cr 
  &  = \sigma _h^2(k) + {(1 + {\psi _1})^2}\sigma _h^2(k - 1) +  \cdot  \cdot  \cdot  + (\sum\limits_{i = 0}^{k - 1} {{\psi _i}{)^2}} \sigma _h^2(1) \cr} $$其中${V_h(k)}$ 表示在给定$F_h$条件下z的条件方差，$\sigma _h^2(l)$是在预测原点h处的超前l步波动率预测。如果波动率模型是上面的GARCH模型，那么这些波动率预测可以由第4章讨论的方法递归得到。
















































