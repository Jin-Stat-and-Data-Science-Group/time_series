---
title: "分析baidu股票"
output:
  html_document:
    number_sections: yes
  bookdown::html_document2: default
---
```{r setup, echo=F}
knitr::opts_knit$set(root.dir = getwd())
#knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

# 获取数据，计算收益率
```{r}
#加载包
rm(list=ls())
library(TTR)
library(xts)
library(zoo)
library(quantmod)
library(fBasics)
library(knitr)
library(tseries)
library(forecast)
#从雅虎财经中获得百度公司的数据
#getSymbols('BIDU') 
#write.csv(as.data.frame(BIDU),"./data/BIDU.csv",row.names = T)
BIDU <- read.csv("./data/BIDU.csv")
BIDU <- xts(BIDU[,-1],order.by = as.Date(BIDU$X))
dim(BIDU) #查看数据维度3273条，6个变量
head(BIDU) 
tail(BIDU) #2007-01-03至2020-01-03数据
#计算日对数收益率
options(digits = 4)
rt =diff(log(BIDU$BIDU.Adjusted))[-1] #去掉第一个空值
```


# 描述性统计分析
## 描述性数据
```{r}
x1=c(mean(rt),sd(rt),skewness(rt),kurtosis(rt))
x1=as.data.frame(x1)
rownames(x1)=c("均值","标准差","偏态系数","峰态系数")
x1
```

从收益率数据特征可知，对数收益率的偏度为`r x1[3,1]`，峰度为`r x1[4,1]`，而正态分布的偏度和峰度分别为0和3，
故对数收益率序列具有左偏性和尖峰性，初步判断不服从正态分布。

## 图形描述
### 时序图
```{r fig1,eval=T,fig.cap = "Baidu日对数收益率时序图", dev='png'}
chartSeries(rt,theme="white")  
```

从图\@ref(fig:fig1)中可以看出收益率在2007.1.4-2020.1.2整体波动较平稳，但存在一些较大的异常值，有些时期波动很大（厚尾现象），其他时期比较稳定（收益率波动集聚现象）,序列可能存在异方差。

### 直方图和正态Q-Q图
```{r hist, fig.cap="收益率频率分布直方图和正态Q-Q图", dev='png'}
par(mfrow=c(1,2))
#绘制直方图
hist(rt,main=NULL,breaks = 50)
#正态性检验
qqnorm(rt,main =NULL)
qqline(rt)
```

图 \@ref(fig:hist) 的直方图和QQ图也显示对数收益率序列不服从正态分布。直方图中，对数收益率序列的左尾部长于普通正态分布，具有金融序列的尖峰厚尾特征。QQ图中对数收益率的散点明显偏离代表正态分布的直线，在左侧表现出散点图分布向下，右侧表现出分布向上扬，说明该序列具有明显的尖峰厚尾特征。

# 正态性检验
```{r}
#正态性检验
jarque.bera.test(rt)  
```

用J-B（Jarque-Bera）统计量对收益率数据进行正态性检验，J-B统计量对应的p值小于2e-16,小于显著性水平0.05，故拒绝原假设，证明收益率数据不服从正态分布的判断。

# 白噪声检验

```{r}
Box.test(rt,lag = 12,type = 'Lj')
```

从检验结果可以看出，p值=0.03，小于显著性水平0.05，拒绝原假设。收益率序列是非白噪声序列，需要进一步提取序列相关信息。

```{r fig2, fig.cap="Baidu日对数收益率自相关图和偏自相关图", dev='png'}
#自相关性检验
acf(rt)
pacf(rt)
```
从图\@ref(fig:fig2) 自相关图和偏自相关图可以看出，样本自相关系数和偏自相关系数具有拖尾性。

# 平稳性检验
```{r}
pp.test(rt)
```
P值=0.01，小于显著性水平0.05，表明该序列是平稳的。

# 构建ARMA模型
综合以上分析，使用ARMA(1,1),ARMA(1,2)、ARMA(2,1)、ARMA(2,2)对序列进行拟合。
```{r}
fit1=arima(rt,order = c(1,0,0))#ARMA(1,0)
fit1
ABIC1=c("fit1",AIC(fit1),BIC(fit1))
fit2=arima(rt,order = c(1,0,1))#ARMA(1,1)
fit2
ABIC2=c("fit2",AIC(fit2),BIC(fit2))
fit3=arima(rt,order = c(2,0,1))#ARMA(2,1)
fit3
ABIC3=c("fit3",AIC(fit3),BIC(fit3))
fit4=arima(rt,order = c(1,0,2))#ARMA(1,2)
fit4
ABIC4=c("fit4",AIC(fit4),BIC(fit4))
fit5=arima(rt,order = c(2,0,2))#ARMA(2,2)
fit5
ABIC5=c("fit5",AIC(fit5),BIC(fit5))
#auto.arima(rt)
ABIC=data.frame(ABIC1,ABIC2,ABIC3,ABIC4,ABIC5)
ABIC

```

考虑参数的显著性和AIC、BIC准则，选择ARMA(2,2)最优.较其他模型而言，ARMA(2,2)的AIC、BIC最小。

```{r}
#残差白噪声检验
resi<-residuals(fit5,standardize=F)
Box.test(resi,lag=12,type = "Ljung")
```
检验结果显示，残差序列为白噪声序列，无序列自相关性。

# ARCH效应检验
```{r}
library(FinTS)
ArchTest(resi,lag=12)
```

由检验结果可知，p值<2e-16，拒绝原假设，说明残差序列存在ARCH效应,具有异方差性,构建GARCH模型

# 构建GARCH模型
```{r}
library(fGarch)
rfit=garchFit(~arma(2,2)+garch(1,1),data=rt,trace=F)  #新息服从正态分布
summary(rfit)
```

完整拟合模型为$$\left\{\begin{array}{l}
{ r_t=-0.0987r_{t-1}-0.9166r_{t-2}+a_t+0.122a_{t-1}+0.9011a_{t-2}}\\
{a_{t}=\sigma_{t} \varepsilon _{t}} \\
{\sigma_{t}^2=0.9728 \sigma_{t-1}^2+0.02114 a_{t-1}^{2}}
\end{array}\right.$$

# VaR计算

综上分析，我们得到了新息为正态分布的ARMA(2,2)XGARCH(1,1)模型，根据该模型计算VaR值
```{r}
#VaR计算函数
RMeasure<- function(mu,sigma,cond.dist="norm",df=0){
# calculate VaR and ES for a specified conditional distribution
# p = 0.05, 0.01, 0.001
#
# cond.dist = "norm", "t", "std"
prob=c(0.95,0.99,0.999)
if(cond.dist=="norm"){
q1=qnorm(prob)
d1=dnorm(q1)
VaR=mu+q1*sigma
ES=mu+d1/(1-prob)*sigma
tt=cbind(prob,VaR,ES)
}
#
if(cond.dist=="std"){
library(fGarch)
if(df < 2.001)df=2.01
q1=qstd(prob,nu=df)
d1=dstd(q1,nu=df)
VaR=mu+q1*sigma*sqrt(df/(df-2))
ES=mu+sigma*sqrt(df/(df-2))*(d1/(1-prob))*(((df-2)+q1^2)/(df-1))
tt=cbind(prob,VaR,ES)
}
#
if(cond.dist=="t"){
if(df < 2.01)df=2.01
q1=qt(prob,df)
d1=dt(q1,df)
VaR=mu+q1*sigma
ES=mu+sigma*(d1/(1-prob))*((df+q1^2)/(df-1))
tt=cbind(prob,VaR,ES)
}
cat("\n Risk Measures for selected probabilities: \n")
print(tt)

RMeasure <- list(results=tt)
}
predict(rfit,3) #均值的三个预测值
RMeasure(0.0002770482,0.02651697)
```

由结果可知，在T=2020/1/2时刻，超前1步预测的收益率均值0.0002770482，波动率为0.02651697，相应的风险值为$$VaR_{0.95}=0.04389358,ES_{0.95}=0.05497394\\
VaR_{0.99}=0.06196474,ES_{0.99}=0.07095045\\
VaR_{0.999}=0.08222065,ES_{0.999}=0.08956207$$





