---
title: "金融数据分析导论练习"
author: "wangmengyuan"
date: "2020-1-8"
output:
  html_document:
    df_print: paged
    toc: no
  bookdown::pdf_document2:
    keep_tex: yes
    latex_engine: xelatex
    md_extensions: +east_asian_line_breaks
    pandoc_args:
    - --listing
    - --filter
    - pandoc-crossref
    toc: no
  bookdown::word_document2:
    fig_caption: yes
    md_extensions: +east_asian_line_breaks
    pandoc_args:
    - --filter
    - pandoc-crossref
    reference_docx: ./style/word-styles-02.docx
  bookdown::html_document2:
    fig_caption: yes
    highlight: haddock
    keep_md: yes
    md_extensions: +east_asian_line_breaks
    number_sections: yes
    pandoc_args:
    - --filter
    - pandoc-crossref
    - -M
    - eqnPrefix=
    seq_numbering: yes
    theme: null
    toc: yes
css: ./style/markdown.css
bibliography: Bibfile.bib
eqnPrefixTemplate: ($$i$$)
link-citations: yes
linkReferences: yes
csl: ./style/chinese-gb7714-2005-numeric.csl
autoEqnLabels: yes
---

#获取数据，计算对数收益率
获取浦东金桥股票数据，利用2007-01-04到2010-12-31期间股票的收盘价格进行分析
```{r}
#浦东金桥股票数据
rm(list = ls())
library(quantmod)
library(fBasics)
library(zoo)
library(xts)
library(forecast)
#install.packages("fUnitRoots")
#library(fUnitRoots)
#setSymbolLookup(FDJQ=list(name='600639.ss',src='yahoo',form="2007-01-08",to="2010-12-31"))
#getSymbols("FDJQ")
#write.csv(as.data.frame(FDJQ),"./data/FDJQ.csv")
dat <- read.csv("./data/FDJQ.csv")
dat <- na.omit(dat)
head(dat)
dat1 <- xts(dat[,-1],order.by = as.Date(dat$X))

rtn <- diff(log(dat1$X600639.SS.Close))[-1]
```

 #描述性统计分析（图）
## 描述性统计分析值
```{r}
jz <- mean(rtn)
fc <- var(rtn)
zws <- median(rtn)
pd <- skewness(rtn)
fd <- kurtosis(rtn)
x <- data.frame(c(jz,fc,zws,pd,fd),row.names = c("均值","方差","中位数","偏度","峰度"))

```
根据上述的描述分析，样本偏度`r x[3,1]`小于0，样本峰度`r x[4,1]`小于3，该样本具有左偏平顶峰的特点，显然该股票收盘价的对数收益率不服从正态分布。

## 描述性统计分析图
```{r}
hist(rtn,nclass = 30)#直方图
chartSeries(rtn,theme = "white") #时序图
qqnorm(rtn)  #  正态性检验q-q 图
```
对序列画出直方图，时序图，Q-Q图，通过Q-Q图可以检验正态性，因为序列数据离参考线过远，表明数据不服从正态分布。

#白噪声检验
```{r}
for (i in 1:2) print(Box.test(rtn,lag = 6*i,type = "Ljung-Box"))
par(mfcol=c(2,1))
acf(rtn,main="自相关系数图",xlab="滞后阶数")
pacf(rtn,main="偏自相关系数图",xlab="滞后阶数")

```
给定显著性水平0.05，对数收益率的白噪声检验的P值均小于0.05，有充足的理由拒绝原假设，因此该序列不是白噪声序列，序列间存在相关性。序列的自相关系数图拖尾，偏自相关系数图也拖尾，因此需要拟合arma模型。

# 平稳性检验
```{r}
m1=ar(as.numeric(rtn),method = 'mle')#基于AIC准则
m1$order
library(fUnitRoots)
library(tseries)
adfTest(ts(rtn),lag=4,type="c")
ndiffs(rtn)
#经过0次差分后平稳，也说明序列本身是平稳的。
```
P值为0.01，在显著性水平0.05下，拒绝原假设，序列平稳.

# 建arma模型，残差白噪声检验
因为对数收益率序列平稳，自相关系数拖尾，偏自相关系数也拖尾，因此建立ARMA模型，可以先考虑一下模型：ARMA(1,1),ARMA(1,2),ARMA(2,1),ARMA(2,2)，再根据AIC和BIC最小准则确定合适的模型。
```{r}
fit1 <- arima(rtn,order = c(1,0,1),method = "ML")
fit1
x1 <- c("ARMA(1,1)",fit1$aic)
fit2 <- arima(rtn,order = c(1,0,2),method = "ML")
fit2
x2 <- c("ARMA(1,2)",fit2$aic)
fit3 <- arima(rtn,order = c(2,0,1),method = "ML")
fit3
x3 <- c("ARMA(2,1)",fit3$aic)
fit4 <- arima(rtn,order = c(2,0,2),method = "ML")
fit4
x4 <- c("ARMA(2,2)",fit4$aic)
x <- data.frame(x1,x2,x3,x4)
rownames(x) = c("模型","AIC")
x
```
根据AIC最小的准则选择适合的模型，经比较，模型ARMA(2,2)最合适,AIC值最小。

## 残差白噪声检验
```{r}
for (i in 1:2) {
  print(Box.test(fit4$residuals,lag=i*6,type = "Ljung-Box"))
}
```
对模型残差进行白噪声检验，模型的P值大于显著性水平0.05，没有足够的理由拒绝原假设，因此残差序列是白噪声序列，不存在序列相关性。

# arch效应检验
```{r}
#LB统计量
res <- fit4$residuals
mean(res)
yt=res-mean(res)
Box.test(yt^2,lag=12,type = "Ljung-Box")
install.packages("FinTS") 
library(FinTS)  
ArchTest(coredata(res))#检验
#两种检验都确定了苹果公司的月对数收益率中存在ARCH效应

```
（1）可以利用LB统计量检验是否存在arch效应，P值接近于0，拒绝原假设，因此表明有很强的ARCH效应。

（2）直接用ArchTest()函数来检验，P值接近于0,也说明了残差序列存在ARCH效应,因此序列具有异方差性,可以构建GARCH模型

# 正态性检验
```{r}
#JB统计量
T=length(res)
s1 <- skewness(res)
s2 <- kurtosis(res)
JB <- s1^2/(6/T)+(s2-3)^2/(24/T)#服从自由度为2的卡方分布
p <- 1-pchisq(JB,2)
p  #p值为0
library(fBasics)
normalTest(res,method = 'jb')
#P值接近于0，拒绝原假设，因此对数收益率不服从正态分布
```
利用JB统计量检验或函数normalTest()检验正态性，都拒绝正态性分布的原假设。

# 建Garch模型
```{r}
library(fGarch)
m2 <- garchFit(~garch(1,1),data=rtn,trace = F)
summary(m2)
```
GARCH模型通用的时间序列模型可以写为：
$$\eqalign{
  & {r_t} =  - 3.136e - 04 + {a_t}  \cr 
  & {a_t} = {\sigma _t}{\varepsilon _t}{\rm{  ,  }}{\varepsilon _t} \sim N(0,1)  \cr 
  & \sigma _t^2 = 1.041e - 05 + 0.04047a_{t - 1}^2 + 0.9507\sigma _{t - 1}^2 \cr} $$

# 根据garch模型计算VaR
在时刻T=975，均值和波动率的超前一步预测分别为-0.0003136214和0.02427867。
```{r}
predict(m2,3)
RMeasure<- function(mu,sigma,cond.dist="norm",df=0){
# calculate VaR and ES for a specified conditional distribution
# p = 0.05, 0.01, 0.001
# cond.dist = "norm", "t", "std"
prob=c(0.95,0.99,0.999)
if(cond.dist=="norm"){
q1=qnorm(prob)
d1=dnorm(q1)
VaR=mu+q1*sigma
ES=mu+d1/(1-prob)*sigma
tt=cbind(prob,VaR,ES)
}
#
if(cond.dist=="std"){
library(fGarch)
if(df < 2.001)df=2.01
q1=qstd(prob,nu=df)
d1=dstd(q1,nu=df)
VaR=mu+q1*sigma
ES=mu+sigma*(d1/(1-prob))*(((df-2)+q1^2)/(df-1))
tt=cbind(prob,VaR,ES)
}
#
if(cond.dist=="t"){
if(df < 2.01)df=2.01
q1=qt(prob,df)
d1=dt(q1,df)
#VaR=mu+q1*sigma
VaR=mu+q1*sigma/sqrt(df/(df-2))
ES=mu+sigma/sqrt(df/(df-2))*(d1/(1-prob))*((df+q1^2)/(df-1))
tt=cbind(prob,VaR,ES)
}
cat("\n Risk Measures for selected probabilities: \n")
print(tt)

RMeasure <- list(results=tt)
}
RMeasure(-0.0003136214,0.02427867,cond.dist = "norm",df=0)

```


